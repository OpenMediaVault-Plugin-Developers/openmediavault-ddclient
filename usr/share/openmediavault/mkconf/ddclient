#!/bin/sh
#
# Copyright (C) 2015 OpenMediaVault Plugin Developers
#
# This file is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# This file is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this file. If not, see <http://www.gnu.org/licenses/>.

set -e

. /etc/default/openmediavault
. /usr/share/openmediavault/scripts/helper-functions

SERVICE="ddclient"
CONF_DIR="/etc/${SERVICE}"
DDCLIENT_CONF="/etc/${SERVICE}/${SERVICE}.conf"
CACHE_DIR="/var/cache/${SERVICE}"

if [ "$(omv_config_get "//services/ddclient/enable")" != "1" ]; then
    exit 0
fi

if [ ! -d "${CONF_DIR}" ]; then
        mkdir -p "${CONF_DIR}"
        chmod 755 "${CONF_DIR}"
fi

if [ ! -d "${CACHE_DIR}" ]; then
        mkdir -p "${CACHE_DIR}"
        chmod 755 "${CACHE_DIR}"
fi

# if [ -f "${CACHE_DIR}/${SERVICE}.cache" ]; then
#        cp /dev/null "${CACHE_DIR}/${SERVICE}.cache"
# fi

    if [ `omv_config_get "//services/ddclient/ddns_type"` = "d" ]; then
        cat <<EOF > ${DDCLIENT_CONF}
# Configuration file for ddclient generated by debconf
#
# /etc/ddclient.conf

daemon="$(omv_config_get "//services/ddclient/seconds")"
ssl=$( if [ `omv_config_get "//services/ddclient/dssl"` = "1" ]; then echo "yes"; else echo "no"; fi)
use=web, web=checkip.dyndns.com/, web-skip='IP Address'
login=$(omv_config_get "//services/ddclient/dusername")
password=$(omv_config_get "//services/ddclient/dpassword")
protocol=dyndns2
server=members.dyndns.org
wildcard=$( if [ `omv_config_get "//services/ddclient/dwildcard"` = "1" ]; then echo "yes"; else echo "no"; fi)
$(omv_config_get "//services/ddclient/dhostname")
EOF

    else
        cat <<EOF > ${DDCLIENT_CONF}
daemon="$(omv_config_get "//services/ddclient/seconds")"
use=web, web=checkip.dyndns.com/, web-skip='IP Address'
login=$(omv_config_get "//services/ddclient/nusername")
password=$(omv_config_get "//services/ddclient/npassword")
protocol=dyndns2
server=dynupdate.no-ip.com
$(omv_config_get "//services/ddclient/nhostname")
EOF

    fi





